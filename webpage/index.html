<html>
<head>
	<script type="text/javascript" src="js/socket.io-1.3.5.js"></script>
	<script type="text/javascript" src="js/d3.v3.min.js"></script>
	<script type="text/javascript" src="js/dimple.v2.1.2.min.js"></script>
</head>
<body>
	<div style="font-family: Tahoma, sans-serif; position: absolute">
		Metric: <select id="sel">
			<option>rss</option>
			<option selected>heapUsed</option>
			<option>heapTotal</option>
			<option>diffRSSAndTotal</option>
		</select>
	</div>
	<div id="chartContainer"></div>
	<script type="text/javascript">
		d3.select( '#sel' ).on( 'change', function( d ) {
			chart.data = dimple.filterData( arrData, 'type', this.value );
			chart.draw();
		});

		var arrData, x, y, chart, svg, socket, isInit = true;
		
		arrData = [];
		svg = dimple.newSvg( '#chartContainer', '100%', '100%' );

		window.onresize = function () {
			if( chart ) chart.draw( 0, true );
		};
		
		socket = io();
		socket.on( 'connection', function(socket) {
			console.log('connected');
		});
		socket.on( 'init', function( o ) {
			console.log('init');
			if( chart ) {
				chart.svg.selectAll( '*' ).remove();
				chart = null;
			}
			arrData = [];
		});
		socket.on( 'endinit', function() {
			console.log('endinit');
			isInit = null;
			if( chart ) chart.draw();
		});
		socket.on( 'memusage', function( arr ) {
			var begin;
			console.log( arr );
			if( arr.length > 0 ) begin = arr[0].timestamp;
			for (var i = 0; i < arr.length; i++) {
				arrData.push({
					category: arr[i].category,
					timestamp: arr[i].timestamp - begin,
					memory: arr[i].rss,
					file: arr[i].file,
					type: 'rss'
				});
				arrData.push({
					category: arr[i].category,
					timestamp: arr[i].timestamp - begin,
					memory: arr[i].heapUsed,
					file: arr[i].file,
					type: 'heapUsed'
				});
				arrData.push({
					category: arr[i].category,
					timestamp: arr[i].timestamp - begin,
					memory: arr[i].heapTotal,
					file: arr[i].file,
					type: 'heapTotal'
				});
				arrData.push({
					category: arr[i].category,
					timestamp: arr[i].timestamp - begin,
					memory: arr[i].rss - arr[i].heapTotal,
					file: arr[i].file,
					type: 'diffRSSAndTotal'
				});
			}
			
			if( !chart ) {
				chart = new dimple.chart( svg, arrData );
				// chart.setBounds( 60, 30, 505, 305 );
                chart.setMargins("60px", "30px", "110px", "70px");

				// x.addOrderRule("Date");
				x = chart.addTimeAxis( 'x', 'timestamp' );
				x.tickFormat = '%b %e %H:%M';
				x.title = 'Time';

				y = chart.addMeasureAxis( 'y', 'memory' );
				// chart.addColorAxis( 'rss', ["green", "yellow", "red"] );
				y.title = 'Memory';
				var s = chart.addSeries( 'file', dimple.plot.line );
				chart.addLegend( 60, 10, 500, 20, 'right' );
			}

			chart.data = dimple.filterData( arrData, 'category', 'before' );
			chart.data = dimple.filterData( arrData, 'type', 'heapUsed' );
		});
		
		
// var svg = dimple.newSvg("#chartContainer", 590, 400);
// var data = [
//     { Animal: "Cats", Value: (Math.random() * 1000000) },
//     { Animal: "Dogs", Value: (Math.random() * 1000000) },
//     { Animal: "Mice", Value: (Math.random() * 1000000) }
// ];
// var chart = new dimple.chart(svg, data);
// chart.setBounds(60, 30, 510, 305)
// var x = chart.addCategoryAxis("x", "Animal"); 
// x.addOrderRule(["Cats", "Dogs", "Mice"]);
// chart.addMeasureAxis("y", "Value");
// chart.addSeries(null, dimple.plot.bar);
// chart.draw();

// d3.select("#btn").on("click", function() {
//     chart.data = [
//         { Animal: "Cats", Value: (Math.random() * 1000000) },
//         { Animal: "Dogs", Value: (Math.random() * 1000000) },
//         { Animal: "Mice", Value: (Math.random() * 1000000) }
//     ];
//     chart.draw(1000);
// });
	</script>
</body>
</html>